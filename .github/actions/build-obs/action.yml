name: Build obs-studio

inputs:
  use_cache:
    description: 'Set "true" if obs-studio directory was restored.'
    required: true
  obs_hash:
    description: 'Hash of the obs-studio commit'
    required: true

runs:
  using: composite

  steps:
    - name: 'Restore obs-build-dependencies directory'
      id: obs-build-dependencies-cache
      if: ${{ runner.os == 'Linux' && (github.event_name != 'schedule' || inputs.use_cache == 'true') }}
      uses: actions/cache/restore@v3
      with:
        path: obs-build-dependencies
        key: obs-build-dependencies-${{ runner.os }}-${{ inputs.obs_hash }}
        restore-keys: obs-build-dependencies-${{ runner.os }}-

    - name: 'Apply patches'
      shell: bash
      run: |
        set -ex
        cd obs-studio
        if test "${{ inputs.use_cache }}" != 'true'; then
          for p in ../patch/*.patch; do
            conflict=$(awk '/^Conflict:/{print $2}' $p)
            requires=$(awk '/^Requires:/{print $2}' $p)
            if test -n "$conflict" && git merge-base --is-ancestor "$conflict" HEAD; then
              echo "Info: Skipping $p because of conflicting $conflict"
              continue
            fi
            if test -n "$requires" && ! git merge-base --is-ancestor "$requires" HEAD; then
              echo "Info: Skipping $p because of missing requirement $requires"
              continue
            fi
            patch -p1 < $p
          done
        fi

    - name: 'Configure and build obs-studio'
      if: ${{ runner.os == 'Linux' }}
      shell: bash
      run: |
        set -ex
        sudo apt update
        sudo apt install -y zsh
        cd obs-studio
        if test "${{ inputs.use_cache }}" != 'true'; then
          export RESTORED_CEF=''
          .github/scripts/build-linux
        else
          .github/scripts/build-linux --skip-build
        fi

    - name: 'Build obs-studio'
      if: ${{ runner.os == 'macOS' && inputs.use_cache != 'true' }}
      shell: bash
      run: |
        REMOVE_FORMULAS=""
        for FORMULA in ${{ env.BLOCKED_FORMULAS }}; do
          if [ -d "/usr/local/opt/${FORMULA}" ]; then
            REMOVE_FORMULAS="${REMOVE_FORMULAS} ${FORMULA}"
          fi
        done
        if [ -n "${REMOVE_FORMULAS}" ]; then
          brew uninstall ${REMOVE_FORMULAS}
        fi

        cd obs-studio
        rm -rf build_macos/OBS.app
        export -n SEEKING_TESTERS
        export TERM=''
        .github/scripts/build-macos --target macos-x86_64

    - name: 'Save obs-build-dependencies directory'
      uses: actions/cache/save@v3
      if: ${{ runner.os == 'Linux' && inputs.use_cache != 'true' }}
      with:
        path: obs-build-dependencies
        key: obs-build-dependencies-${{ runner.os }}-${{ inputs.obs_hash }}

